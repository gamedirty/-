# 在Android上运行多进程程序
*当单独的Dalvik虚拟机不再够用的时候*

###远离内存限制
   Android有很多特有的优点让其成为一个移动操作系统，但是有时候，要实现这些功能是很难得，特别是从开发者的角度出发。
比如说内存使用的限制。和iOS的200MB比，Android应用的内存被严格的限制在24/32/48MB，对大部分老的设备甚至限制到了16mb。

这个预算就是你的APP所有执行内容的限制。就是说，这个内存需要满足你加载类、线程、服务、UI资源和所有你的APP想要展示的内容。想象一下一个展示一个网格图片的图片浏览应用和一个需要在后台播放应用的音乐播放器：额啊啊啊啊
![image](https://cdn-images-1.medium.com/max/1600/1*A06U7LBzP-yOK4lBIyboig.gif)
想要了解为啥Android设置了这些限制和为处理这个问题Android提供的解决方法，让我们通过一些列小的知识点来揭开庐山真面目吧。

###Android processes:解释
你应该已经知道了，Android系统是基于Linux的。这就是说，**每一个应用是运行在他自己的进程中的**(用一个唯一的PID来区分)：这就使得APP运行在一个独立的环境中，这个环境对其他的应用来说是隔绝的。特别的，当你想要启动一个应用程序，Android就会启动一个进程(万恶的zygote)，启动了main线程并启动了主activity。

另外你可能不知道的是，**你可以指定你的应用程序的某些组件运行到不同的进程上去**，而不是只使用一个进程来运行你的程序。这就讲到的这个关键的属性：

```
android:process
```

这个进程属性可以被应用到activity 、service、contentprovider 和broadcast receivers上去，并且可以指定部分组件应该执行在哪个进程上。

在下边这个例子中，我指定了MusicService必须运行在一个单独的music进程上：

```
<manifest ...>
  <application
    android:icon="@drawable/ic_launcher"
    android:label="@string/app_name"
    android:theme="@style/Theme.Main" >
    
    <activity
      android:name=".MusicActivity"
      />
    <service
      android:name=".MusicService"
      android:process=":music"
    />
  </application>
</manifest>
```
这是不是很棒恩？

在这个介绍中，我提到了每一个Android应用都有一个定值的内存来让你的应用去执行并且不能超过这个值。确切的说，这个限制只是对一个进程的限制。**也就是说，应用的每个进程都被声明了一个内存使用限制。**（不考虑不同的终止方式）

让我们看看这个方法究竟是好是坏[剧透：两者都是]

###那么有多个进程到底有什么好处呢

就像我刚刚说的，一个独立的进程可以有它自己的内存预算，这样就可以允许主进程有更多的空间去处理它自己的资源。

另外，运行在不同进程的程序的组件会被系统区别对待。这就意味着，当系统内存不足的时候，**一个APP的所有进程不一定都会被杀死**。想象这个情况：你的音乐播放器运行在后台并且正在播放音乐；突然系统需要释放一些内存。（因为Facebook O(∩_∩)O哈哈~）。如果你正在播放音乐的服务运行在另外一个进程，系统就极有可能先杀死主进程(运行APPUI的进程)，留下音乐在其它进程播放。

###使用多进程最恶心的是啥呢

不幸的是，特别多。你应该要清楚使用多进程方式开发应用程序是很有难度的。

首先，进程作为一个安全的功能在设计上是被独立开的，这就意味着**每一个进程都有他独立的Dalvik虚拟机实例**。也就是，你不能通过这些实例来共享数据，至少是在传统观念上。例如static的变量在不同的进程上都有自己的值，而不是你下意识会认为的只有一个值。*并且这个可以扩展到应用程序的每一个状态上*。

那这是不是意味着内部通讯在两个进程间就是不可能的了呢？不，当然可以，并且有若干个方式可以做到这个。最容易被考虑到的是intent可以跨进程，handler和messenger也可以。你也可以依赖aidl和Binder，你通常在bindservice的时候使用的方式。

###我真的需要多进程么？

这当然需要根据用户的反馈。如果你的用户出现内存泄漏的情况越来越频繁或者他们抱怨为什么你的APP内存不足，你应该考虑使用一个或者多个进程了。

音乐播放器就是一个使用多进程可以让你的APP更好工作的常见情况，但是当然还有更多情况。比如，你的APP是一个云储存服务的客户端：
把同步服务的组件声明在一个独立的进程看起来是一个非常合理做法，这样就算你的UI进程被系统给杀掉了，这个服务仍然可以运行并且保证所有的文件都是最新的。
![image](https://cdn-images-1.medium.com/max/800/1*kdbqGwu7oRSIOLX4JQa0JQ.gif)

如果你认为你需要，那么我建议你在一个小的测试应用上先试验一下。除非你清楚的知道使用多进程的有事和固有的疑难地方，这样你就能决定你是否真的需要它，和使用时候不会发疯的方法。

###写在最后
这个文章只是简单的说明了这个主题的某个方面，我只是想给你一些实践建议并不是想从系统层面上详细介绍所有的理论和工作机制。


